# kubsh — Инструкции для AI-агентов

## Архитектура проекта

**kubsh** — это учебная реализация POSIX-совместимой командной оболочки на C++17 с поддержкой виртуальной файловой системы пользователей через FUSE.

### Основные компоненты

1. **[src/main.cpp](../src/main.cpp)** — REPL интерпретатор команд
   - Парсинг команд с поддержкой одиночных кавычек (`'...'`)
   - Встроенные команды: `echo`, `\q`, `history`, `\e $VAR`, `\l /dev/device`
   - Запуск внешних программ через `fork()` + `execvp()`
   - История команд в `~/kubsh_history`
   - Обработка `SIGHUP` → "Configuration reloaded"

2. **[src/vfs.cpp](../src/vfs.cpp)** — FUSE VFS для каталога `users/`
   - Монтируется при старте, размонтируется при завершении
   - Читаемая структура: `/users/{username}/{id|home|shell}`
   - Синхронное создание/удаление пользователей через `useradd`/`userdel`
   - Кэширование пользователей из `getpwent()`

### Ключевые паттерны

- **Fork-exec модель**: Внешние команды выполняются в отдельном процессе, родитель ждёт завершения
- **Парсинг ручной**: Базовое разбиение по пробелам, поддержка однокавычек (без экранирования)
- **FUSE операции**: `getattr`, `readdir`, `open`, `read`, `mkdir`, `rmdir` — как минимально необходимо для VFS
- **Синхронные системные вызовы**: `fork()`, `waitpid()`, `execlp()` для создания/удаления пользователей

## Сборка и запуск

```bash
make build    # Компиляция: g++ -std=c++17 -Wall -Wextra -Werror
make run      # Запуск ./kubsh
make deb      # Создание deb-пакета
make clean    # Очистка артефактов
```

**Зависимости**: `libfuse3-dev` (или `fuse3`), `g++`, `make`

**Требования**: C++17, Linux с FUSE, root права для `mkdir/rmdir` в VFS

## Рекомендации для разработки

- **Добавление встроенной команды**: Добавьте проверку в `isBuiltin` блок, затем логику в главный цикл
- **Расширение VFS**: Модифицируйте `vfs.cpp` операции `fuse_operations`; помните о кэше пользователей
- **История команд**: Сохраняется только непустые строки (исключены `\q`, `history`); читается из файла при команде `history`
- **Парсинг**: Нет поддержки двойных кавычек, экранирования или подстановки `$VAR` в аргументах — добавляйте осторожно
- **Безопасность VFS**: `mkdir`/`rmdir` требуют root; проверка прав доступа минимальна

## Специфические файлы

- `Makefile` — сборка; переменные `CXX`, `CXXFLAGS`, `LDFLAGS`
- `kubsh-package/DEBIAN/control` — метаданные deb-пакета

---

**Контекст**: Проект из курса CodeCrafters "Build Your Own Shell". Фокус на простоте реализации с фундаментальными концепциями (fork/exec, FUSE, парсинг).
